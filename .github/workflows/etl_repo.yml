name: REPO ETL
on: 
  schedule:
   - cron: "0 8 * * SUN"
jobs:
  update_repo_info:
    name: Extract Repo Info
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        alpha: [0, 1]
        split_cnt: [2]
    steps:
      - name: checkout 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: 'main'
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh-known-hosts: github.com
      - name: Set Up Python 
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'
      - name: Run install
        run: |
          pip install requests==2.28.2
          pip install tqdm
          pip install pypistats==1.1.0
          pip install toolz
          pip install cytoolz==0.12.1
          pip install httpx==0.23.0
      - name: Insert PAT
        run: echo ${{ secrets.PERSONAL_TOKEN }} >> pat.key
      - name: Run update script
        run: python update_repo_info_all.py data/latest.menu ${{ matrix.alpha }} ${{ matrix.split_cnt }}
      - name: Upload Tmp Jsonl
        uses: actions/upload-artifact@v3
        with:
          name: "${{ matrix.alpha }}"
          path: /tmp/info.jsonl
          retention-days: 1
  merge_repo_infos:
    name: Merge Infos 
    needs: update_repo_info
    runs-on: ubuntu-latest
    steps:
      - name: checkout 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: 'main'
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh-known-hosts: github.com
      - name: Download Jsonls
        uses: actions/download-artifact@v3
        with:
          path: download
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: download
      - name: Merge jsonl
        run: |
          rm -f data/repo_info.jsonl
          cat download/{0..1}/info.jsonl >> data/repo_info.jsonl
      - name: Git commit
        run: |
          git config --global user.name "jeffrey82221"
          git config --global user.email "jeffrey82221@gmail.com"
          git add data/repo_info.jsonl
          git diff-index --quiet HEAD || git commit -m 'update: email content'
      - name: Git pull
        run: |
          git config --global user.email "jeffrey82221@gmail.com"
          git config --global user.name "jeffrey82221"
          git config pull.rebase false
          git pull origin main || echo 'pull failed'
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.PERSONAL_TOKEN }}
          branch: main

